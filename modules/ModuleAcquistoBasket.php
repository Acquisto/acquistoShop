<?php                                                                                                                                                                                                                                                                                                                 | <?php 
                                                                                                                                                                                                                                                                                                                      | 
/**                                                                                                                                                                                                                                                                                                                   | /**
 * The AcquistoShop extension allows to create an online                                                                                                                                                                                                                                                              |  * The AcquistoShop extension allows to create an online 
 * store with the OpenSource Contao CMS. If you have                                                                                                                                                                                                                                                                  |  * store with the OpenSource Contao CMS. If you have
 * questions our website: http://www.contao-acquisto.de                                                                                                                                                                                                                                                               |  * questions our website: http://www.contao-acquisto.de  
 *                                                                                                                                                                                                                                                                                                                    |  *
 * PHP version 5                                                                                                                                                                                                                                                                                                      |  * PHP version 5
 * @package	   AcquistoShop                                                                                                                                                                                                                                                                                           |  * @package	   AcquistoShop
 * @subpackage Frontend                                                                                                                                                                                                                                                                                               |  * @subpackage Frontend
 * @author     Sascha Brandhoff <brandhoff@contao-acquisto.de>                                                                                                                                                                                                                                                        |  * @author     Sascha Brandhoff <brandhoff@contao-acquisto.de>
 * @copyright  AcquistoShop                                                                                                                                                                                                                                                                                           |  * @copyright  AcquistoShop
 * @license    LGPL.                                                                                                                                                                                                                                                                                                  |  * @license    LGPL.
 * @filesource                                                                                                                                                                                                                                                                                                        |  * @filesource
 */                                                                                                                                                                                                                                                                                                                   |  */
                                                                                                                                                                                                                                                                                                                      |  
namespace AcquistoShop\Frontend;                                                                                                                                                                                                                                                                                      | namespace AcquistoShop\Frontend;
                                                                                                                                                                                                                                                                                                                      |  
class ModuleAcquistoBasket extends \Module                                                                                                                                                                                                                                                                            | class ModuleAcquistoBasket extends \Module
{                                                                                                                                                                                                                                                                                                                     | {
                                                                                                                                                                                                                                                                                                                      | 
    /**                                                                                                                                                                                                                                                                                                               |     /**
     * Template                                                                                                                                                                                                                                                                                                       |      * Template
     * @var string                                                                                                                                                                                                                                                                                                    |      * @var string
     */                                                                                                                                                                                                                                                                                                               |      */
    protected $strTemplate          = 'mod_warenkorb';                                                                                                                                                                                                                                                                |     protected $strTemplate          = 'mod_warenkorb';
    protected $strVersandberechnung = null;                                                                                                                                                                                                                                                                           |     protected $strVersandberechnung = null;
    protected $floatBerechnung      = 0;                                                                                                                                                                                                                                                                              |     protected $floatBerechnung      = 0;
    private $basketData             = array();                                                                                                                                                                                                                                                                        |     private $basketData             = array();
                                                                                                                                                                                                                                                                                                                      | 
                                                                                                                                                                                                                                                                                                                      | 
    /**                                                                                                                                                                                                                                                                                                               |     /**
     * Display a wildcard in the back end                                                                                                                                                                                                                                                                             |      * Display a wildcard in the back end
     * @return string                                                                                                                                                                                                                                                                                                 |      * @return string
     */                                                                                                                                                                                                                                                                                                               |      */
    public function generate()                                                                                                                                                                                                                                                                                        |     public function generate() 
    {                                                                                                                                                                                                                                                                                                                 |     {
        if (TL_MODE == 'BE')                                                                                                                                                                                                                                                                                          |         if (TL_MODE == 'BE') 
        {                                                                                                                                                                                                                                                                                                             |         {
            $objTemplate = new \BackendTemplate('be_wildcard');                                                                                                                                                                                                                                                       |             $objTemplate = new \BackendTemplate('be_wildcard');
                                                                                                                                                                                                                                                                                                                      | 
            $objTemplate->wildcard = '### ACQUISTO BASKET ###';                                                                                                                                                                                                                                                       |             $objTemplate->wildcard = '### ACQUISTO BASKET ###';
            $objTemplate->title = $this->headline;                                                                                                                                                                                                                                                                    |             $objTemplate->title = $this->headline;
            $objTemplate->id = $this->id;                                                                                                                                                                                                                                                                             |             $objTemplate->id = $this->id;
            $objTemplate->link = $this->name;                                                                                                                                                                                                                                                                         |             $objTemplate->link = $this->name;
            $objTemplate->href = 'contao/main.php?do=themes&amp;table=tl_module&amp;act=edit&amp;id=' . $this->id;                                                                                                                                                                                                    |             $objTemplate->href = 'contao/main.php?do=themes&amp;table=tl_module&amp;act=edit&amp;id=' . $this->id;
                                                                                                                                                                                                                                                                                                                      | 
            return $objTemplate->parse();                                                                                                                                                                                                                                                                             |             return $objTemplate->parse();
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      | 
        /**                                                                                                                                                                                                                                                                                                           |         /**
         * Import der entsprechenden Klassen die für den Warenkorb                                                                                                                                                                                                                                                    |          * Import der entsprechenden Klassen die für den Warenkorb 
         * benötigt werden.                                                                                                                                                                                                                                                                                           |          * benötigt werden.
         */                                                                                                                                                                                                                                                                                                           |          */                  
        $this->Import('AcquistoShop\acquistoShop',              'Shop');                                                                                                                                                                                                                                              |         $this->Import('AcquistoShop\acquistoShop',              'Shop');
        $this->Import('AcquistoShop\acquistoShopBasket',        'Basket');                                                                                                                                                                                                                                            |         $this->Import('AcquistoShop\acquistoShopBasket',        'Basket');
        $this->Import('AcquistoShop\acquistoShopPayment',       'Payment');                                                                                                                                                                                                                                           |         $this->Import('AcquistoShop\acquistoShopPayment',       'Payment');
        $this->Import('AcquistoShop\acquistoShopProduktLoader', 'Produkt');                                                                                                                                                                                                                                           |         $this->Import('AcquistoShop\acquistoShopProduktLoader', 'Produkt');
//         $this->Import('AcquistoShop\acquistoShopGutschein',     'Gutschein');                                                                                                                                                                                                                                      | //         $this->Import('AcquistoShop\acquistoShopGutschein',     'Gutschein');
        $this->Import('AcquistoShop\acquistoShopOrders',        'Orders');                                                                                                                                                                                                                                            |         $this->Import('AcquistoShop\acquistoShopOrders',        'Orders');
        $this->import('FrontendUser',                           'Member');                                                                                                                                                                                                                                            |         $this->import('FrontendUser',                           'Member');
                                                                                                                                                                                                                                                                                                                      |         
        /**                                                                                                                                                                                                                                                                                                           |         /**
         * Setzen des Warenkorb-Typs (brutto, netto, durch Preisliste definiert)                                                                                                                                                                                                                                      |          * Setzen des Warenkorb-Typs (brutto, netto, durch Preisliste definiert)
         */                                                                                                                                                                                                                                                                                                           |          */
                                                                                                                                                                                                                                                                                                                      |         
        $cardType = $this->acquistoShop_basketType;                                                                                                                                                                                                                                                                   |         $cardType = $this->acquistoShop_basketType;
        if($cardType == 'pricelist')                                                                                                                                                                                                                                                                                  |         if($cardType == 'pricelist') 
        {                                                                                                                                                                                                                                                                                                             |         {
             $objPricelist = \AcquistoShop\acquistoShopCosts::getSelectedPricelist($this->Member->groups);                                                                                                                                                                                                            |              $objPricelist = \AcquistoShop\acquistoShopCosts::getSelectedPricelist($this->Member->groups);
             $cardType = $objPricelist->type;                                                                                                                                                                                                                                                                         |              $cardType = $objPricelist->type;
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      |                          
        $this->Basket->cardType = $cardType;                                                                                                                                                                                                                                                                          |         $this->Basket->cardType = $cardType;
                                                                                                                                                                                                                                                                                                                      |         
        if($this->Input->Post('FORM_SUBMIT') == 'tl_acquistoShop_warenkorb_update' && is_array($this->Input->Post('menge')))                                                                                                                                                                                          |         if($this->Input->Post('FORM_SUBMIT') == 'tl_acquistoShop_warenkorb_update' && is_array($this->Input->Post('menge'))) 
        {                                                                                                                                                                                                                                                                                                             |         {
            foreach($this->Input->Post('menge') as $keyId => $menge)                                                                                                                                                                                                                                                  |             foreach($this->Input->Post('menge') as $keyId => $menge) 
            {                                                                                                                                                                                                                                                                                                         |             {
                $this->Basket->update($keyId, $menge);                                                                                                                                                                                                                                                                |                 $this->Basket->update($keyId, $menge);
            }                                                                                                                                                                                                                                                                                                         |             }    
                                                                                                                                                                                                                                                                                                                      | 
            \AcquistoShop\acquistoShop::reload();                                                                                                                                                                                                                                                                     | 
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      | 
        if($this->Input->Get('remove'))                                                                                                                                                                                                                                                                               |         if($this->Input->Get('remove')) 
        {                                                                                                                                                                                                                                                                                                             |         {
            $this->Basket->remove($this->Input->Get('remove'));                                                                                                                                                                                                                                                       |             $this->Basket->remove($this->Input->Get('remove'));
        }                                                                                                                                                                                                                                                                                                             |         }                
                                                                                                                                                                                                                                                                                                                      | 
        /**                                                                                                                                                                                                                                                                                                           |         /**
         * Setzen der Berechnungsvariante für Versandkosten (Gewicht, Endpreis)                                                                                                                                                                                                                                       |          * Setzen der Berechnungsvariante für Versandkosten (Gewicht, Endpreis)
         */                                                                                                                                                                                                                                                                                                           |          */                 
        switch(strtolower($GLOBALS['TL_CONFIG']['versandberechnung']))                                                                                                                                                                                                                                                |         switch(strtolower($GLOBALS['TL_CONFIG']['versandberechnung'])) 
        {                                                                                                                                                                                                                                                                                                             |         {
            case "gewicht":                                                                                                                                                                                                                                                                                           |             case "gewicht":
                $this->strVersandberechnung = "gewicht";                                                                                                                                                                                                                                                              |                 $this->strVersandberechnung = "gewicht";
                $this->floatBerechnung = $this->Basket->getWeight();                                                                                                                                                                                                                                                  |                 $this->floatBerechnung = $this->Basket->getWeight();
                break;;                                                                                                                                                                                                                                                                                               |                 break;;
            default:                                                                                                                                                                                                                                                                                                  |             default:
                $this->strVersandberechnung = "preis";                                                                                                                                                                                                                                                                |                 $this->strVersandberechnung = "preis";
                $this->floatBerechnung = $this->Basket->getCosts();                                                                                                                                                                                                                                                   |                 $this->floatBerechnung = $this->Basket->getCosts();
                break;;                                                                                                                                                                                                                                                                                               |                 break;;
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      | 
        return parent::generate();                                                                                                                                                                                                                                                                                    |         return parent::generate();
    }                                                                                                                                                                                                                                                                                                                 |     }
                                                                                                                                                                                                                                                                                                                      | 
    private function checkfields($fields = array(), $mandatory = array())                                                                                                                                                                                                                                             |     private function checkfields($fields = array(), $mandatory = array()) 
    {                                                                                                                                                                                                                                                                                                                 |     {
        $this->loadDataContainer('tl_member');                                                                                                                                                                                                                                                                        |         $this->loadDataContainer('tl_member');
        $dataArray = $this->buildfields($mandatory);                                                                                                                                                                                                                                                                  |         $dataArray = $this->buildfields($mandatory);
        $error = null;                                                                                                                                                                                                                                                                                                |         $error = null;
                                                                                                                                                                                                                                                                                                                      |         
        if(is_array($dataArray))                                                                                                                                                                                                                                                                                      |         if(is_array($dataArray)) 
        {                                                                                                                                                                                                                                                                                                             |         {
            $this->Import('Validator');                                                                                                                                                                                                                                                                               |             $this->Import('Validator');
                                                                                                                                                                                                                                                                                                                      |             
            foreach($dataArray as $key => $value)                                                                                                                                                                                                                                                                     |             foreach($dataArray as $key => $value) 
            {                                                                                                                                                                                                                                                                                                         |             {                
                $arrData = &$GLOBALS['TL_DCA']['tl_member']['fields'][$key];                                                                                                                                                                                                                                          |                 $arrData = &$GLOBALS['TL_DCA']['tl_member']['fields'][$key];
                $isValue = null;                                                                                                                                                                                                                                                                                      |                 $isValue = null;                    
                                                                                                                                                                                                                                                                                                                      | 
                if($value->mandatory == 2 && !$fields[$key])                                                                                                                                                                                                                                                          |                 if($value->mandatory == 2 && !$fields[$key]) 
                {                                                                                                                                                                                                                                                                                                     |                 {
                    $error[$key] = true;                                                                                                                                                                                                                                                                              |                     $error[$key] = true;                                    
                }                                                                                                                                                                                                                                                                                                     |                 }
                                                                                                                                                                                                                                                                                                                      |                                
                if($fields[$key])                                                                                                                                                                                                                                                                                     |                 if($fields[$key]) 
                {                                                                                                                                                                                                                                                                                                     |                 {
                    switch($arrData['eval']['rgxp'])                                                                                                                                                                                                                                                                  |                     switch($arrData['eval']['rgxp']) 
                    {                                                                                                                                                                                                                                                                                                 |                     {
                        case "digit":                                                                                                                                                                                                                                                                                 |                         case "digit":
                            $isValue = "isNumeric";                                                                                                                                                                                                                                                                   |                             $isValue = "isNumeric";                
                            break;;                                                                                                                                                                                                                                                                                   |                             break;;
                        case "alpha":                                                                                                                                                                                                                                                                                 |                         case "alpha":
                            $isValue = "isAlphabetic";                                                                                                                                                                                                                                                                |                             $isValue = "isAlphabetic";                
                            break;;                                                                                                                                                                                                                                                                                   |                             break;;
                        case "alnum":                                                                                                                                                                                                                                                                                 |                         case "alnum":
                            $isValue = "isAlphanumeric";                                                                                                                                                                                                                                                              |                             $isValue = "isAlphanumeric";                
                            break;;                                                                                                                                                                                                                                                                                   |                             break;;
                        case "prcnt":                                                                                                                                                                                                                                                                                 |                         case "prcnt":
                            $isValue = "isPercent";                                                                                                                                                                                                                                                                   |                             $isValue = "isPercent";                
                            break;;                                                                                                                                                                                                                                                                                   |                             break;;
                        case "date":                                                                                                                                                                                                                                                                                  |                         case "date":
                            $isValue = "isDate";                                                                                                                                                                                                                                                                      |                             $isValue = "isDate";                
                            break;;                                                                                                                                                                                                                                                                                   |                             break;;
                        case "time":                                                                                                                                                                                                                                                                                  |                         case "time":
                            $isValue = "isTime";                                                                                                                                                                                                                                                                      |                             $isValue = "isTime";                
                            break;;                                                                                                                                                                                                                                                                                   |                             break;;
                        case "dateim":                                                                                                                                                                                                                                                                                |                         case "dateim":
                            $isValue = "isDatim";                                                                                                                                                                                                                                                                     |                             $isValue = "isDatim";                
                            break;;                                                                                                                                                                                                                                                                                   |                             break;;
                        case "email":                                                                                                                                                                                                                                                                                 |                         case "email":
                            $isValue = "isEmail";                                                                                                                                                                                                                                                                     |                             $isValue = "isEmail";                
                            break;;                                                                                                                                                                                                                                                                                   |                             break;;
                        case "url":                                                                                                                                                                                                                                                                                   |                         case "url":
                            $isValue = "isUrl";                                                                                                                                                                                                                                                                       |                             $isValue = "isUrl";                
                            break;;                                                                                                                                                                                                                                                                                   |                             break;;
                        case "phone":                                                                                                                                                                                                                                                                                 |                         case "phone":
                            $isValue = "isPhone";                                                                                                                                                                                                                                                                     |                             $isValue = "isPhone";                                    
                            break;;                                                                                                                                                                                                                                                                                   |                             break;;
                    }                                                                                                                                                                                                                                                                                                 |                     }
                }                                                                                                                                                                                                                                                                                                     |                 }
                                                                                                                                                                                                                                                                                                                      |                 
                if($isValue)                                                                                                                                                                                                                                                                                          |                 if($isValue) 
                {                                                                                                                                                                                                                                                                                                     |                 {                
                    if(!$this->Validator->$isValue($fields[$key]))                                                                                                                                                                                                                                                    |                     if(!$this->Validator->$isValue($fields[$key])) 
                    {                                                                                                                                                                                                                                                                                                 |                     {
                        $error[$key] = true;                                                                                                                                                                                                                                                                          |                         $error[$key] = true;
                    }                                                                                                                                                                                                                                                                                                 |                     }
                }                                                                                                                                                                                                                                                                                                     |                 }
            }                                                                                                                                                                                                                                                                                                         |             }
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      |                 
        return $error;                                                                                                                                                                                                                                                                                                |         return $error;    
    }                                                                                                                                                                                                                                                                                                                 |     }
                                                                                                                                                                                                                                                                                                                      |     
    private function buildfields($fields = array(), $error = array())                                                                                                                                                                                                                                                 |     private function buildfields($fields = array(), $error = array()) 
    {                                                                                                                                                                                                                                                                                                                 |     {
        $this->loadLanguageFile('tl_member');                                                                                                                                                                                                                                                                         |         $this->loadLanguageFile('tl_member');
                                                                                                                                                                                                                                                                                                                      |         
                                                                                                                                                                                                                                                                                                                      |         
        if(is_array($fields))                                                                                                                                                                                                                                                                                         |         if(is_array($fields)) 
        {                                                                                                                                                                                                                                                                                                             |         {
            foreach($fields as $value)                                                                                                                                                                                                                                                                                |             foreach($fields as $value) 
            {                                                                                                                                                                                                                                                                                                         |             {
                if($value['field'])                                                                                                                                                                                                                                                                                   |                 if($value['field']) 
                {                                                                                                                                                                                                                                                                                                     |                 {
                    $mandatorySelect = false;                                                                                                                                                                                                                                                                         |                     $mandatorySelect = false;
                    if($value['mandatory'] == 2)                                                                                                                                                                                                                                                                      |                     if($value['mandatory'] == 2) 
                    {                                                                                                                                                                                                                                                                                                 |                     {
                            $mandatorySelect = true;                                                                                                                                                                                                                                                                  |                             $mandatorySelect = true;                                                        
                    }                                                                                                                                                                                                                                                                                                 |                     }
                                                                                                                                                                                                                                                                                                                      |     
                    $rebuildFields[$value['field']] = (object) array(                                                                                                                                                                                                                                                 |                     $rebuildFields[$value['field']] = (object) array(                
                        'label'     => $GLOBALS['TL_LANG']['tl_member'][$value['field']][0],                                                                                                                                                                                                                          |                         'label'     => $GLOBALS['TL_LANG']['tl_member'][$value['field']][0],
                        'key'       => $value['field'],                                                                                                                                                                                                                                                               |                         'key'       => $value['field'],
                        'mandatory' => $mandatorySelect,                                                                                                                                                                                                                                                              |                         'mandatory' => $mandatorySelect,
                        'error'     => $error[$value['field']],                                                                                                                                                                                                                                                       |                         'error'     => $error[$value['field']],
                        'errorMessage' => $value['error'],                                                                                                                                                                                                                                                            |                         'errorMessage' => $value['error'],
                        'infoMessage'  => $value['info']                                                                                                                                                                                                                                                              |                         'infoMessage'  => $value['info']
                    );                                                                                                                                                                                                                                                                                                |                     );
                }                                                                                                                                                                                                                                                                                                     |                 }
            }                                                                                                                                                                                                                                                                                                         |             }
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      | 
        return $rebuildFields;                                                                                                                                                                                                                                                                                        |         return $rebuildFields;        
    }                                                                                                                                                                                                                                                                                                                 |     }
                                                                                                                                                                                                                                                                                                                      |     
    private function explodeValues($values, $selected = null) {                                                                                                                                                                                                                                                       |     private function explodeValues($values, $selected = null) {
        $explodeValue = explode(",", $values);                                                                                                                                                                                                                                                                        |         $explodeValue = explode(",", $values);
                                                                                                                                                                                                                                                                                                                      |         
        if(is_array($explodeValue) && count($explodeValue)) {                                                                                                                                                                                                                                                         |         if(is_array($explodeValue) && count($explodeValue)) {
            foreach($explodeValue as $value) {                                                                                                                                                                                                                                                                        |             foreach($explodeValue as $value) {
                $selection = false;                                                                                                                                                                                                                                                                                   |                 $selection = false;
                                                                                                                                                                                                                                                                                                                      |                 
                if(substr_count($value, "&#61;") OR substr_count($value, "=")) {                                                                                                                                                                                                                                      |                 if(substr_count($value, "&#61;") OR substr_count($value, "=")) {
                    if(substr_count($value, "&#61;")) {                                                                                                                                                                                                                                                               |                     if(substr_count($value, "&#61;")) {
                        $explodeSign = "&#61;";                                                                                                                                                                                                                                                                       |                         $explodeSign = "&#61;";
                    } else {                                                                                                                                                                                                                                                                                          |                     } else {
                        $explodeSign = "=";                                                                                                                                                                                                                                                                           |                         $explodeSign = "=";
                    }                                                                                                                                                                                                                                                                                                 |                     }
                                                                                                                                                                                                                                                                                                                      |                     
                    $explodeSub = explode($explodeSign, $value);                                                                                                                                                                                                                                                      |                     $explodeSub = explode($explodeSign, $value);
                                                                                                                                                                                                                                                                                                                      |                     
                    if(is_array($selected)) {                                                                                                                                                                                                                                                                         |                     if(is_array($selected)) {
                        if(in_array($explodeSub[0], $selected)) {                                                                                                                                                                                                                                                     |                         if(in_array($explodeSub[0], $selected)) {
                            $selection = true;                                                                                                                                                                                                                                                                        |                             $selection = true;                                            
                        }                                                                                                                                                                                                                                                                                             |                         }
                    } elseif($selected == $explodeSub[0]) {                                                                                                                                                                                                                                                           |                     } elseif($selected == $explodeSub[0]) {
                        $selection = true;                                                                                                                                                                                                                                                                            |                         $selection = true;                    
                    }                                                                                                                                                                                                                                                                                                 |                     }
                                                                                                                                                                                                                                                                                                                      |                        
                    $valueNew = (object) array(                                                                                                                                                                                                                                                                       |                     $valueNew = (object) array(
                        'value'    => $explodeSub[0],                                                                                                                                                                                                                                                                 |                         'value'    => $explodeSub[0],
                        'label'    => $explodeSub[1],                                                                                                                                                                                                                                                                 |                         'label'    => $explodeSub[1],
                        'selected' => $selection                                                                                                                                                                                                                                                                      |                         'selected' => $selection
                    );                                                                                                                                                                                                                                                                                                |                     );
                } else {                                                                                                                                                                                                                                                                                              |                 } else {
                    if(is_array($selected)) {                                                                                                                                                                                                                                                                         |                     if(is_array($selected)) {
                        if(in_array($value, $selected)) {                                                                                                                                                                                                                                                             |                         if(in_array($value, $selected)) {
                            $selection = true;                                                                                                                                                                                                                                                                        |                             $selection = true;                                            
                        }                                                                                                                                                                                                                                                                                             |                         }
                    } elseif($selected == $value) {                                                                                                                                                                                                                                                                   |                     } elseif($selected == $value) {
                        $selection = true;                                                                                                                                                                                                                                                                            |                         $selection = true;                    
                    }                                                                                                                                                                                                                                                                                                 |                     }
                                                                                                                                                                                                                                                                                                                      | 
                    $valueNew = (object) array(                                                                                                                                                                                                                                                                       |                     $valueNew = (object) array(
                        'value'    => $value,                                                                                                                                                                                                                                                                         |                         'value'    => $value,
                        'label'    => $value,                                                                                                                                                                                                                                                                         |                         'label'    => $value,
                        'selected' => $selection                                                                                                                                                                                                                                                                      |                         'selected' => $selection
                    );                                                                                                                                                                                                                                                                                                |                     );
                }                                                                                                                                                                                                                                                                                                     |                 }          
                                                                                                                                                                                                                                                                                                                      |     
                $return[] = $valueNew;                                                                                                                                                                                                                                                                                |                 $return[] = $valueNew;
            }                                                                                                                                                                                                                                                                                                         |             }            
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      | 
        return $return;                                                                                                                                                                                                                                                                                               |         return $return;            
    }                                                                                                                                                                                                                                                                                                                 |     }
                                                                                                                                                                                                                                                                                                                      |     
    private function checkAddonFields($values = null, $fields) {                                                                                                                                                                                                                                                      |     private function checkAddonFields($values = null, $fields) {
        $error = false;                                                                                                                                                                                                                                                                                               |         $error = false;
                                                                                                                                                                                                                                                                                                                      |         
        if(count($fields)) {                                                                                                                                                                                                                                                                                          |         if(count($fields)) {
            foreach($fields as $value) {                                                                                                                                                                                                                                                                              |             foreach($fields as $value) {
                if($value['mandatory'] == 2 && !$values[$value['fieldname']]) {                                                                                                                                                                                                                                       |                 if($value['mandatory'] == 2 && !$values[$value['fieldname']]) {                    
                    $error = true;                                                                                                                                                                                                                                                                                    |                     $error = true;
                }                                                                                                                                                                                                                                                                                                     |                 }
            }                                                                                                                                                                                                                                                                                                         |             }
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      |         
        return $error;                                                                                                                                                                                                                                                                                                |         return $error;
    }                                                                                                                                                                                                                                                                                                                 |     }
                                                                                                                                                                                                                                                                                                                      |     
    private function buildAddonFields($fields, $values = null) {                                                                                                                                                                                                                                                      |     private function buildAddonFields($fields, $values = null) {
        if($this->Input->Post('custom')) {                                                                                                                                                                                                                                                                            |         if($this->Input->Post('custom')) {
            $fieldsPost = $this->Input->Post('custom');                                                                                                                                                                                                                                                               |             $fieldsPost = $this->Input->Post('custom');
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      |         
        if(count($fields)) {                                                                                                                                                                                                                                                                                          |         if(count($fields)) {
            foreach($fields as $key => $value) {                                                                                                                                                                                                                                                                      |             foreach($fields as $key => $value) {
                $value = (object) $value;                                                                                                                                                                                                                                                                             |                 $value = (object) $value;
                if($value->fieldname && $value->fieldtype && $value->fieldtitle) {                                                                                                                                                                                                                                    |                 if($value->fieldname && $value->fieldtype && $value->fieldtitle) {
                    $htmlOptions  = null;                                                                                                                                                                                                                                                                             |                     $htmlOptions  = null;
                    $explodeValue = null;                                                                                                                                                                                                                                                                             |                     $explodeValue = null;
                    $mandatory    = null;                                                                                                                                                                                                                                                                             |                     $mandatory    = null;
                    $selected     = null;                                                                                                                                                                                                                                                                             |                     $selected     = null;
                    $selectedText = null;                                                                                                                                                                                                                                                                             |                     $selectedText = null;
                                                                                                                                                                                                                                                                                                                      |     
                    if($value->mandatory == 2) {                                                                                                                                                                                                                                                                      |                     if($value->mandatory == 2) {
                        $mandatory = '*';                                                                                                                                                                                                                                                                             |                         $mandatory = '*';
                        if(!$fieldsPost[$value->fieldname] && $fieldsPost) {                                                                                                                                                                                                                                          |                         if(!$fieldsPost[$value->fieldname] && $fieldsPost) {
                            $value->error = true;                                                                                                                                                                                                                                                                     |                             $value->error = true;
                        }                                                                                                                                                                                                                                                                                             |                         }    
                    }                                                                                                                                                                                                                                                                                                 |                     }
                                                                                                                                                                                                                                                                                                                      |                     
                                                                                                                                                                                                                                                                                                                      |                     
                    switch($value->fieldtype) {                                                                                                                                                                                                                                                                       |                     switch($value->fieldtype) {                   
                        case "select":                                                                                                                                                                                                                                                                                |                         case "select":
                            $explodeValue = $this->explodeValues($value->value, $values[$value->fieldname]);                                                                                                                                                                                                          |                             $explodeValue = $this->explodeValues($value->value, $values[$value->fieldname]);
                                                                                                                                                                                                                                                                                                                      |                             
                            foreach($explodeValue as $optionValue) {                                                                                                                                                                                                                                                  |                             foreach($explodeValue as $optionValue) {
                                if($optionValue->selected) {                                                                                                                                                                                                                                                          |                                 if($optionValue->selected) {
                                    $selected = ' selected="selected"';                                                                                                                                                                                                                                               |                                     $selected = ' selected="selected"';
                                    $selectedText = $optionValue->label;                                                                                                                                                                                                                                              |                                     $selectedText = $optionValue->label;
                                }                                                                                                                                                                                                                                                                                     |                                 }
                                                                                                                                                                                                                                                                                                                      |                                 
                                $htmlOptions .= '<option value="' . $optionValue->value . '"' . $selected . '>' . $optionValue->label . '</option>';                                                                                                                                                                  |                                 $htmlOptions .= '<option value="' . $optionValue->value . '"' . $selected . '>' . $optionValue->label . '</option>';
                            }                                                                                                                                                                                                                                                                                         |                             }
                                                                                                                                                                                                                                                                                                                      |                         
                            $htmlObject = (object) array(                                                                                                                                                                                                                                                             |                             $htmlObject = (object) array(
                                'label' => '<label for="addon_' . $key . '_' . $value->fieldname . '">' . $value->fieldtitle . $mandatory . '</label>',                                                                                                                                                               |                                 'label' => '<label for="addon_' . $key . '_' . $value->fieldname . '">' . $value->fieldtitle . $mandatory . '</label>',
                                'input' => '<select name="custom[' . $value->fieldname . ']" id="addon_' . $key . '_' . $value->fieldname . '" tabindex="' . $key . '">' . $htmlOptions . '</select>'                                                                                                                 |                                 'input' => '<select name="custom[' . $value->fieldname . ']" id="addon_' . $key . '_' . $value->fieldname . '" tabindex="' . $key . '">' . $htmlOptions . '</select>'
                            );                                                                                                                                                                                                                                                                                        |                             );
                                                                                                                                                                                                                                                                                                                      |                             
                            $value->selected = $selectedText;                                                                                                                                                                                                                                                         |                             $value->selected = $selectedText;                                            
                            break;;                                                                                                                                                                                                                                                                                   |                             break;;
                        case "text":                                                                                                                                                                                                                                                                                  |                         case "text":
                            if($values[$value->fieldname]) {                                                                                                                                                                                                                                                          |                             if($values[$value->fieldname]) {
                                $value->value = $values[$value->fieldname];                                                                                                                                                                                                                                           |                                 $value->value = $values[$value->fieldname];
                            }                                                                                                                                                                                                                                                                                         |                             }
                                                                                                                                                                                                                                                                                                                      |                         
                            $htmlObject = (object) array(                                                                                                                                                                                                                                                             |                             $htmlObject = (object) array(
                                'label' => '<label for="addon_' . $key . '_' . $value->fieldname . '">' . $value->fieldtitle . $mandatory . '</label>',                                                                                                                                                               |                                 'label' => '<label for="addon_' . $key . '_' . $value->fieldname . '">' . $value->fieldtitle . $mandatory . '</label>',
                                'input' => '<input type="text" name="custom[' . $value->fieldname . ']" id="addon_' . $key . '_' . $value->fieldname . '" value="' . $value->value . '" tabindex="' . $key . '">'                                                                                                     |                                 'input' => '<input type="text" name="custom[' . $value->fieldname . ']" id="addon_' . $key . '_' . $value->fieldname . '" value="' . $value->value . '" tabindex="' . $key . '">'
                            );                                                                                                                                                                                                                                                                                        |                             );
                                                                                                                                                                                                                                                                                                                      |                             
                            $value->selected = $values[$value->fieldname];                                                                                                                                                                                                                                            |                             $value->selected = $values[$value->fieldname];                                            
                            break;;                                                                                                                                                                                                                                                                                   |                             break;;
                        case "checkbox":                                                                                                                                                                                                                                                                              |                         case "checkbox":
                            $explodeValue = $this->explodeValues($value->value, $values[$value->fieldname]);                                                                                                                                                                                                          |                             $explodeValue = $this->explodeValues($value->value, $values[$value->fieldname]);
                                                                                                                                                                                                                                                                                                                      |                             
                            foreach($explodeValue as $optionValue) {                                                                                                                                                                                                                                                  |                             foreach($explodeValue as $optionValue) {
                                $selected = null;                                                                                                                                                                                                                                                                     |                                 $selected = null;
                                if($optionValue->selected) {                                                                                                                                                                                                                                                          |                                 if($optionValue->selected) {
                                    $selected = 'checked="checked"';                                                                                                                                                                                                                                                  |                                     $selected = 'checked="checked"';
                                    $selectedText[] = $optionValue->label;                                                                                                                                                                                                                                            |                                     $selectedText[] = $optionValue->label;
                                }                                                                                                                                                                                                                                                                                     |                                 }
                                                                                                                                                                                                                                                                                                                      |     
                                $htmlOptions .= '<input type="checkbox" name="custom[' . $value->fieldname . '][]" id="addon_' . $key . '_' . $value->fieldname . '" value="' . $optionValue->value . '" tabindex="' . $key . '"' . $selected . '>' . $optionValue->label;                                            |                                 $htmlOptions .= '<input type="checkbox" name="custom[' . $value->fieldname . '][]" id="addon_' . $key . '_' . $value->fieldname . '" value="' . $optionValue->value . '" tabindex="' . $key . '"' . $selected . '>' . $optionValue->label;
                            }                                                                                                                                                                                                                                                                                         |                             }
                                                                                                                                                                                                                                                                                                                      |                         
                            $htmlObject = (object) array(                                                                                                                                                                                                                                                             |                             $htmlObject = (object) array(
                                'label' => '<label for="addon_' . $key . '_' . $value->fieldname . '">' . $value->fieldtitle . $mandatory . '</label>',                                                                                                                                                               |                                 'label' => '<label for="addon_' . $key . '_' . $value->fieldname . '">' . $value->fieldtitle . $mandatory . '</label>',
                                'input' => $htmlOptions                                                                                                                                                                                                                                                               |                                 'input' => $htmlOptions
                            );                                                                                                                                                                                                                                                                                        |                             );
                                                                                                                                                                                                                                                                                                                      | 
                            if($selectedText) {                                                                                                                                                                                                                                                                       |                             if($selectedText) {
                                $value->selected = implode(", ", $selectedText);                                                                                                                                                                                                                                      |                                 $value->selected = implode(", ", $selectedText);
                            }                                                                                                                                                                                                                                                                                         |                             }                                            
                            break;;                                                                                                                                                                                                                                                                                   |                             break;;
                        case "radio":                                                                                                                                                                                                                                                                                 |                         case "radio":
                            $explodeValue = $this->explodeValues($value->value, $values[$value->fieldname]);                                                                                                                                                                                                          |                             $explodeValue = $this->explodeValues($value->value, $values[$value->fieldname]);
                                                                                                                                                                                                                                                                                                                      |     
                            foreach($explodeValue as $optionValue) {                                                                                                                                                                                                                                                  |                             foreach($explodeValue as $optionValue) {
                                if($optionValue->selected) {                                                                                                                                                                                                                                                          |                                 if($optionValue->selected) {
                                    $selected = 'checked="checked"';                                                                                                                                                                                                                                                  |                                     $selected = 'checked="checked"';
                                    $selectedText = $optionValue->label;                                                                                                                                                                                                                                              |                                     $selectedText = $optionValue->label;
                                }                                                                                                                                                                                                                                                                                     |                                 }
                                                                                                                                                                                                                                                                                                                      |     
                                $htmlOptions .= '<input type="radio" name="custom[' . $value->fieldname . ']" id="addon_' . $key . '_' . $value->fieldname . '" value="' . $optionValue->value . '" tabindex="' . $key . '"' . $selected . '>' . $optionValue->label;                                                 |                                 $htmlOptions .= '<input type="radio" name="custom[' . $value->fieldname . ']" id="addon_' . $key . '_' . $value->fieldname . '" value="' . $optionValue->value . '" tabindex="' . $key . '"' . $selected . '>' . $optionValue->label;
                            }                                                                                                                                                                                                                                                                                         |                             }
                            $htmlObject = (object) array(                                                                                                                                                                                                                                                             |                             $htmlObject = (object) array(
                                'label' => '<label for="addon_' . $key . '_' . $value->fieldname . '">' . $value->fieldtitle . $mandatory . '</label>',                                                                                                                                                               |                                 'label' => '<label for="addon_' . $key . '_' . $value->fieldname . '">' . $value->fieldtitle . $mandatory . '</label>',
                                'input' => $htmlOptions                                                                                                                                                                                                                                                               |                                 'input' => $htmlOptions
                            );                                                                                                                                                                                                                                                                                        |                             );
                                                                                                                                                                                                                                                                                                                      |                             
                            $value->selected = $selectedText;                                                                                                                                                                                                                                                         |                             $value->selected = $selectedText;                                            
                            break;;                                                                                                                                                                                                                                                                                   |                             break;;
                        case "textarea":                                                                                                                                                                                                                                                                              |                         case "textarea":
                            if($values[$value->fieldname]) {                                                                                                                                                                                                                                                          |                             if($values[$value->fieldname]) {
                                $value->value = $values[$value->fieldname];                                                                                                                                                                                                                                           |                                 $value->value = $values[$value->fieldname];
                            }                                                                                                                                                                                                                                                                                         |                             }
                                                                                                                                                                                                                                                                                                                      |     
                            $htmlObject = (object) array(                                                                                                                                                                                                                                                             |                             $htmlObject = (object) array(
                                'label' => '<label for="addon_' . $key . '_' . $value->fieldname . '">' . $value->fieldtitle . $mandatory . '</label>',                                                                                                                                                               |                                 'label' => '<label for="addon_' . $key . '_' . $value->fieldname . '">' . $value->fieldtitle . $mandatory . '</label>',
                                'input' => '<textarea name="custom[' . $value->fieldname . ']" id="addon_' . $key . '_' . $value->fieldname . '" tabindex="' . $key . '">' . $value->value . '</textarea>'                                                                                                            |                                 'input' => '<textarea name="custom[' . $value->fieldname . ']" id="addon_' . $key . '_' . $value->fieldname . '" tabindex="' . $key . '">' . $value->value . '</textarea>'
                            );                                                                                                                                                                                                                                                                                        |                             );
                                                                                                                                                                                                                                                                                                                      |                             
                            $value->selected = $values[$value->fieldname];                                                                                                                                                                                                                                            |                             $value->selected = $values[$value->fieldname];                                            
                            break;;                                                                                                                                                                                                                                                                                   |                             break;;
                    }                                                                                                                                                                                                                                                                                                 |                     }
                                                                                                                                                                                                                                                                                                                      |                     
                    if(is_array($values[$value->fieldname])) {                                                                                                                                                                                                                                                        |                     if(is_array($values[$value->fieldname])) {
                        $values[$value->fieldname] = implode(", ", $values[$value->fieldname]);                                                                                                                                                                                                                       |                         $values[$value->fieldname] = implode(", ", $values[$value->fieldname]);
                    }                                                                                                                                                                                                                                                                                                 |                     }
                                                                                                                                                                                                                                                                                                                      |                     
                    $value->html = $htmlObject;                                                                                                                                                                                                                                                                       |                     $value->html = $htmlObject;
                    $return[$key] = $value;                                                                                                                                                                                                                                                                           |                     $return[$key] = $value;            
                }                                                                                                                                                                                                                                                                                                     |                 }
            }                                                                                                                                                                                                                                                                                                         |             }
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      |     
        return $return;                                                                                                                                                                                                                                                                                               |         return $return;
    }                                                                                                                                                                                                                                                                                                                 |     }
                                                                                                                                                                                                                                                                                                                      |     
    /**                                                                                                                                                                                                                                                                                                               |     /**
     * Generate module                                                                                                                                                                                                                                                                                                |      * Generate module
     */                                                                                                                                                                                                                                                                                                               |      */
    protected function compile() {                                                                                                                                                                                                                                                                                    |     protected function compile() {
        if($this->acquistoShop_guestOrder)                                                                                                                                                                                                                                                                            |         if($this->acquistoShop_guestOrder) 
        {                                                                                                                                                                                                                                                                                                             |         {
                                                                                                                                                                                                                                                                                                                      |             
        }                                                                                                                                                                                                                                                                                                             |         } 
        elseif(FE_USER_LOGGED_IN && !$this->acquistoShop_guestOrder)                                                                                                                                                                                                                                                  |         elseif(FE_USER_LOGGED_IN && !$this->acquistoShop_guestOrder) 
        {                                                                                                                                                                                                                                                                                                             |         {
                                                                                                                                                                                                                                                                                                                      |         
        }                                                                                                                                                                                                                                                                                                             |         } 
        else                                                                                                                                                                                                                                                                                                          |         else 
        {                                                                                                                                                                                                                                                                                                             |         {
            $this->Template = new \FrontendTemplate('mod_warenkorb_access_denied');                                                                                                                                                                                                                                   |             $this->Template = new \FrontendTemplate('mod_warenkorb_access_denied');                
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      |     
        $this->basketData = $this->Session->get('basket_data');                                                                                                                                                                                                                                                       |         $this->basketData = $this->Session->get('basket_data');
        $objPage = $this->Database->prepare("SELECT id, alias FROM tl_page WHERE id=?")->limit(1)->execute($this->replaceInsertTags($this->Shop->getInsertTagPID()));                                                                                                                                                 |         $objPage = $this->Database->prepare("SELECT id, alias FROM tl_page WHERE id=?")->limit(1)->execute($this->replaceInsertTags($this->Shop->getInsertTagPID()));
                                                                                                                                                                                                                                                                                                                      | 
        switch(strtolower($this->Input->Get('do')))                                                                                                                                                                                                                                                                   |         switch(strtolower($this->Input->Get('do')))
        {                                                                                                                                                                                                                                                                                                             |         {
            case 'customer':                                                                                                                                                                                                                                                                                          |             case 'customer':
                $this->basketCustomer();                                                                                                                                                                                                                                                                              |                 $this->basketCustomer();                 
                break;;                                                                                                                                                                                                                                                                                               |                 break;;
            case 'payment-and-shipping':                                                                                                                                                                                                                                                                              |             case 'payment-and-shipping':
                $this->basketPaymentAndShipping();                                                                                                                                                                                                                                                                    |                 $this->basketPaymentAndShipping();
                break;;                                                                                                                                                                                                                                                                                               |                 break;;
            case 'agb':                                                                                                                                                                                                                                                                                               |             case 'agb':
                $this->basketTermsAndConditions();                                                                                                                                                                                                                                                                    |                 $this->basketTermsAndConditions();
                break;;                                                                                                                                                                                                                                                                                               |                 break;;
            case 'check-and-order':                                                                                                                                                                                                                                                                                   |             case 'check-and-order':
                $this->basketCheckAndOrder();                                                                                                                                                                                                                                                                         |                 $this->basketCheckAndOrder();                
                break;;                                                                                                                                                                                                                                                                                               |                 break;;                
            case 'pay':                                                                                                                                                                                                                                                                                               |             case 'pay':
                $this->basketPay();                                                                                                                                                                                                                                                                                   |                 $this->basketPay();
                break;;                                                                                                                                                                                                                                                                                               |                 break;;
            case 'key':                                                                                                                                                                                                                                                                                               |             case 'key':                
//                 if($this->Input->Get('template')) {                                                                                                                                                                                                                                                                | //                 if($this->Input->Get('template')) {
//                     $this->Template = new \FrontendTemplate($this->Input->Get('template'));                                                                                                                                                                                                                        | //                     $this->Template = new \FrontendTemplate($this->Input->Get('template'));
//                     $this->Template->BasketUrl = $this->getBasketUrl();                                                                                                                                                                                                                                            | //                     $this->Template->BasketUrl = $this->getBasketUrl();
//                 }                                                                                                                                                                                                                                                                                                  | //                 }
//                                                                                                                                                                                                                                                                                                                    | //                 
//                 if($this->Input->Get('function')) {                                                                                                                                                                                                                                                                | //                 if($this->Input->Get('function')) {
//                     $objVersandart    = $this->Database->prepare("SELECT * FROM tl_shop_versandzonen_varten WHERE id = ?;")->execute($this->basketData['paymentMethod']);                                                                                                                                          | //                     $objVersandart    = $this->Database->prepare("SELECT * FROM tl_shop_versandzonen_varten WHERE id = ?;")->execute($this->basketData['paymentMethod']);
//                     $objVersandzone   = $this->Database->prepare("SELECT * FROM tl_shop_versandzonen WHERE id = ?;")->execute($objVersandart->pid);                                                                                                                                                                | //                     $objVersandzone   = $this->Database->prepare("SELECT * FROM tl_shop_versandzonen WHERE id = ?;")->execute($objVersandart->pid);
//                     $objZahlungsarten = $this->Database->prepare("SELECT * FROM tl_shop_zahlungsarten WHERE id = ?;")->execute($objVersandart->zahlungsart_id);                                                                                                                                                    | //                     $objZahlungsarten = $this->Database->prepare("SELECT * FROM tl_shop_zahlungsarten WHERE id = ?;")->execute($objVersandart->zahlungsart_id);
//                                                                                                                                                                                                                                                                                                                    | //                                 
//                     $this->Template->Data = $this->Payment->openCallback($this->Input->Get('function'), $objZahlungsarten->payment_module, $objZahlungsarten->id);                                                                                                                                                 | //                     $this->Template->Data = $this->Payment->openCallback($this->Input->Get('function'), $objZahlungsarten->payment_module, $objZahlungsarten->id);
//                 }                                                                                                                                                                                                                                                                                                  | //                 }
                break;;                                                                                                                                                                                                                                                                                               |                 break;;
            default:                                                                                                                                                                                                                                                                                                  |             default:
                $this->basketDefault();                                                                                                                                                                                                                                                                               |                 $this->basketDefault();
                break;;                                                                                                                                                                                                                                                                                               |                 break;;
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      |         
        $objPage = $this->Database->prepare("SELECT id, alias FROM tl_page WHERE id=?")->limit(1)->execute($this->replaceInsertTags($this->Shop->getInsertTagPID()));                                                                                                                                                 |         $objPage = $this->Database->prepare("SELECT id, alias FROM tl_page WHERE id=?")->limit(1)->execute($this->replaceInsertTags($this->Shop->getInsertTagPID()));
        $arrWidgetData = $this->Basket->itemNum();                                                                                                                                                                                                                                                                    |         $arrWidgetData = $this->Basket->itemNum();
                                                                                                                                                                                                                                                                                                                      | 
        /**                                                                                                                                                                                                                                                                                                           |         /**
         * Variablen die in das Template geschrieben werden.                                                                                                                                                                                                                                                          |          * Variablen die in das Template geschrieben werden.
         */                                                                                                                                                                                                                                                                                                           |          */                 
        $this->Template->WarenkorbUrl = $this->generateFrontendUrl($objPage->fetchAssoc());                                                                                                                                                                                                                           |         $this->Template->WarenkorbUrl = $this->generateFrontendUrl($objPage->fetchAssoc());
        $this->Template->cardType     = $this->Basket->cardType;                                                                                                                                                                                                                                                      |         $this->Template->cardType     = $this->Basket->cardType;
        $this->Template->Currency     = \AcquistoShop\acquistoShopCosts::getCurrency(\AcquistoShop\acquistoShopCosts::getSelectedCurrency());                                                                                                                                                                         |         $this->Template->Currency     = \AcquistoShop\acquistoShopCosts::getCurrency(\AcquistoShop\acquistoShopCosts::getSelectedCurrency());
    }                                                                                                                                                                                                                                                                                                                 |     }
                                                                                                                                                                                                                                                                                                                      | 
    public function getBasketUrl()                                                                                                                                                                                                                                                                                    |     public function getBasketUrl() 
    {                                                                                                                                                                                                                                                                                                                 |     {
        return substr($this->Environment->requestUri, 1, strpos($this->Environment->requestUri, "?") - 1);                                                                                                                                                                                                            |         return substr($this->Environment->requestUri, 1, strpos($this->Environment->requestUri, "?") - 1);
    }                                                                                                                                                                                                                                                                                                                 |     }
                                                                                                                                                                                                                                                                                                                      |     
    private function basketDefault()                                                                                                                                                                                                                                                                                  |     private function basketDefault() 
    {                                                                                                                                                                                                                                                                                                                 |     {        
        if($this->Basket->cardType == 'netto')                                                                                                                                                                                                                                                                        |         if($this->Basket->cardType == 'netto')
        {                                                                                                                                                                                                                                                                                                             |         {
            $this->Template->Zwischensumme = $this->Basket->getCosts(false);                                                                                                                                                                                                                                          |             $this->Template->Zwischensumme = $this->Basket->getCosts(false);        
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      | 
        if($this->contaoShop_jumpTo)                                                                                                                                                                                                                                                                                  |         if($this->contaoShop_jumpTo) 
        {                                                                                                                                                                                                                                                                                                             |         {
            $objPage = $this->Database->prepare("SELECT id, alias FROM tl_page WHERE id=?")->limit(1)->execute($this->contaoShop_jumpTo);                                                                                                                                                                             |             $objPage = $this->Database->prepare("SELECT id, alias FROM tl_page WHERE id=?")->limit(1)->execute($this->contaoShop_jumpTo);
            $strUrl  = $this->generateFrontendUrl($objPage->fetchAssoc(), '/produkt/%s');                                                                                                                                                                                                                             |             $strUrl  = $this->generateFrontendUrl($objPage->fetchAssoc(), '/produkt/%s');
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      |         
        $this->Template->Steuern       = $this->Basket->getTaxes();                                                                                                                                                                                                                                                   |         $this->Template->Steuern       = $this->Basket->getTaxes();        
        $this->Template->Endpreis      = $this->Basket->getCosts(true);                                                                                                                                                                                                                                               |         $this->Template->Endpreis      = $this->Basket->getCosts(true);
        $this->Template->Produktliste  = $this->Basket->loadProducts($strUrl);                                                                                                                                                                                                                                        |         $this->Template->Produktliste  = $this->Basket->loadProducts($strUrl);
                                                                                                                                                                                                                                                                                                                      |     
        $orderValue = $this->Basket->isOrderValue(1);                                                                                                                                                                                                                                                                 |         $this->Template->Bestellwert = true;
                                                                                                                                                                                                                                                                                                                      |         $this->Template->Bestellzahl = \AcquistoShop\acquistoShopCosts::costsCalculator($this->Basket->orderValue(1), \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());
                                                                                                                                                                                                                                                                                                                      | 
        $this->Template->Bestellwert      = $orderValue->isOrderValue;                                                                                                                                                                                                                                                |         if(\AcquistoShop\acquistoShopCosts::costsCalculator($this->Basket->orderValue(1), \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency()) >= $this->Basket->getCosts(true)) 
        $this->Template->Bestellzahl      = $orderValue->minOrderValue;                                                                                                                                                                                                                                               |         {
        $this->Template->productsInBasket = $orderValue->productsInBasket;                                                                                                                                                                                                                                            |             $this->Template->Bestellwert = false;
                                                                                                                                                                                                                                                                                                                      |             $this->Template->productsInBasket = count($this->Basket->loadProducts($strUrl));
    }                                                                                                                                                                                                                                                                                                                 |         }     
                                                                                                                                                                                                                                                                                                                      |     }
                                                                                                                                                                                                                                                                                                                      |     
    private function basketCustomer()                                                                                                                                                                                                                                                                                 |     private function basketCustomer() 
    {                                                                                                                                                                                                                                                                                                                 |     {
        if($this->Input->Post('action'))                                                                                                                                                                                                                                                                              |         if($this->Input->Post('action')) 
        {                                                                                                                                                                                                                                                                                                             |         {
            $arrCustomer = $this->Input->Post('customer');                                                                                                                                                                                                                                                            |             $arrCustomer = $this->Input->Post('customer');
            $arrDeliver  = $this->Input->Post('deliver');                                                                                                                                                                                                                                                             |             $arrDeliver  = $this->Input->Post('deliver');
            $arrCustom   = $this->Input->Post('custom');                                                                                                                                                                                                                                                              |             $arrCustom   = $this->Input->Post('custom');
                                                                                                                                                                                                                                                                                                                      |     
            $this->Session->set('Customer', $arrCustomer);                                                                                                                                                                                                                                                            |             $this->Session->set('Customer', $arrCustomer);
            $this->Session->set('Deliver', $arrDeliver);                                                                                                                                                                                                                                                              |             $this->Session->set('Deliver', $arrDeliver);
            $this->Session->set('Custom', $arrCustom);                                                                                                                                                                                                                                                                |             $this->Session->set('Custom', $arrCustom);
                                                                                                                                                                                                                                                                                                                      | 
            if($arrDeliver['alternate'])                                                                                                                                                                                                                                                                              |             if($arrDeliver['alternate']) 
            {                                                                                                                                                                                                                                                                                                         |             {
                $errorDeliver = $this->checkfields($arrDeliver, unserialize($this->acquistoShop_selDeliver));                                                                                                                                                                                                         |                 $errorDeliver = $this->checkfields($arrDeliver, unserialize($this->acquistoShop_selDeliver));                
            }                                                                                                                                                                                                                                                                                                         |             }
                                                                                                                                                                                                                                                                                                                      |             
            if($arrCustom)                                                                                                                                                                                                                                                                                            |             if($arrCustom) 
            {                                                                                                                                                                                                                                                                                                         |             {
                $errorCustom = $this->checkAddonFields($arrCustom, unserialize($this->acquistoShop_fieldsAddon));                                                                                                                                                                                                     |                 $errorCustom = $this->checkAddonFields($arrCustom, unserialize($this->acquistoShop_fieldsAddon));
            }                                                                                                                                                                                                                                                                                                         |             }
                                                                                                                                                                                                                                                                                                                      |     
            $errorBasket = $this->checkfields($arrCustomer, unserialize($this->acquistoShop_selFields));                                                                                                                                                                                                              |             $errorBasket = $this->checkfields($arrCustomer, unserialize($this->acquistoShop_selFields));
                                                                                                                                                                                                                                                                                                                      |                                                   
            if(!$errorDeliver && !$errorBasket && !$errorCustom)                                                                                                                                                                                                                                                      |             if(!$errorDeliver && !$errorBasket && !$errorCustom) 
            {                                                                                                                                                                                                                                                                                                         |             {
                $this->redirect($this->getBasketUrl()  . "?do=payment-and-shipping");                                                                                                                                                                                                                                 |                 $this->redirect($this->getBasketUrl()  . "?do=payment-and-shipping");
            }                                                                                                                                                                                                                                                                                                         |             }
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      |     
                                                                                                                                                                                                                                                                                                                      |     
        if (FE_USER_LOGGED_IN)                                                                                                                                                                                                                                                                                        |         if (FE_USER_LOGGED_IN) 
        {                                                                                                                                                                                                                                                                                                             |         {
            $this->import('FrontendUser', 'User');                                                                                                                                                                                                                                                                    |             $this->import('FrontendUser', 'User');
            $objMember = $this->Database->prepare("SELECT * FROM tl_member WHERE id=?")->limit(1)->execute($this->User->id);                                                                                                                                                                                          |             $objMember = $this->Database->prepare("SELECT * FROM tl_member WHERE id=?")->limit(1)->execute($this->User->id);
            $arrMember = $objMember->row();                                                                                                                                                                                                                                                                           |             $arrMember = $objMember->row();
        }                                                                                                                                                                                                                                                                                                             |         } 
        else                                                                                                                                                                                                                                                                                                          |         else 
        {                                                                                                                                                                                                                                                                                                             |         {
            $arrMember = $this->Session->get('Customer');                                                                                                                                                                                                                                                             |             $arrMember = $this->Session->get('Customer');
        }                                                                                                                                                                                                                                                                                                             |         }                                               
                                                                                                                                                                                                                                                                                                                      |         
        $this->Template = new \FrontendTemplate('mod_warenkorb_customer');                                                                                                                                                                                                                                            |         $this->Template = new \FrontendTemplate('mod_warenkorb_customer');
        $this->Template->Member           = $arrMember;                                                                                                                                                                                                                                                               |         $this->Template->Member           = $arrMember;
        $this->Template->Fields           = $this->buildfields(unserialize($this->acquistoShop_selFields), $errorBasket);                                                                                                                                                                                             |         $this->Template->Fields           = $this->buildfields(unserialize($this->acquistoShop_selFields), $errorBasket);
        $this->Template->addonFields      = $this->buildAddonFields(unserialize($this->acquistoShop_fieldsAddon), $this->Session->get('Custom'));                                                                                                                                                                     |         $this->Template->addonFields      = $this->buildAddonFields(unserialize($this->acquistoShop_fieldsAddon), $this->Session->get('Custom'));
        $this->Template->deliverFields    = $this->buildfields(unserialize($this->acquistoShop_selDeliver), $errorDeliver);                                                                                                                                                                                           |         $this->Template->deliverFields    = $this->buildfields(unserialize($this->acquistoShop_selDeliver), $errorDeliver);
        $this->Template->alternateAddress = $arrDeliver['alternate'];                                                                                                                                                                                                                                                 |         $this->Template->alternateAddress = $arrDeliver['alternate'];
        $this->Template->Customer         = $this->Session->get('Customer');                                                                                                                                                                                                                                          |         $this->Template->Customer         = $this->Session->get('Customer');    
        $this->Template->Deliver          = $this->Session->get('Deliver');                                                                                                                                                                                                                                           |         $this->Template->Deliver          = $this->Session->get('Deliver');    
    }                                                                                                                                                                                                                                                                                                                 |     }
                                                                                                                                                                                                                                                                                                                      |     
    private function basketPaymentAndShipping()                                                                                                                                                                                                                                                                       |     private function basketPaymentAndShipping() 
    {                                                                                                                                                                                                                                                                                                                 |     {
        $arrWidgetData = $this->Basket->itemNum();                                                                                                                                                                                                                                                                    |         $arrWidgetData = $this->Basket->itemNum();
                                                                                                                                                                                                                                                                                                                      |   
        if($this->Input->Post('paymentMethod') OR $this->Input->Post('shippingMethod'))                                                                                                                                                                                                                               |         if($this->Input->Post('paymentMethod') OR $this->Input->Post('shippingMethod')) 
        {                                                                                                                                                                                                                                                                                                             |         {
            $this->basketData['paymentMethod']  = $this->Input->Post('paymentMethod');                                                                                                                                                                                                                                |             $this->basketData['paymentMethod']  = $this->Input->Post('paymentMethod');
            $this->basketData['shippingMethod'] = $this->Input->Post('shippingMethod');                                                                                                                                                                                                                               |             $this->basketData['shippingMethod'] = $this->Input->Post('shippingMethod');
                                                                                                                                                                                                                                                                                                                      |   
            $this->Session->set('basket_data', $this->basketData);                                                                                                                                                                                                                                                    |             $this->Session->set('basket_data', $this->basketData);
                                                                                                                                                                                                                                                                                                                      |   
            if($this->Input->Post('action') && ($this->Input->Post('paymentMethod') && $this->Input->Post('shippingMethod')))                                                                                                                                                                                         |             if($this->Input->Post('action')) 
            {                                                                                                                                                                                                                                                                                                         |             {
                $this->redirect($this->getBasketUrl()  . "?do=agb");                                                                                                                                                                                                                                                  |                 $this->redirect($this->getBasketUrl()  . "?do=agb");
            }                                                                                                                                                                                                                                                                                                         | 
            elseif($this->Input->Post('action'))                                                                                                                                                                                                                                                                      | 
            {                                                                                                                                                                                                                                                                                                         | 
                if(!$this->Input->Post('paymentMethod'))                                                                                                                                                                                                                                                              | 
                {                                                                                                                                                                                                                                                                                                     | 
                    $paymentError = true;                                                                                                                                                                                                                                                                             | 
                }                                                                                                                                                                                                                                                                                                     | 
                                                                                                                                                                                                                                                                                                                      | 
                if(!$this->Input->Post('shippingMethod'))                                                                                                                                                                                                                                                             | 
                {                                                                                                                                                                                                                                                                                                     | 
                    $shippingError = true;                                                                                                                                                                                                                                                                            | 
                }                                                                                                                                                                                                                                                                                                     | 
            }                                                                                                                                                                                                                                                                                                         |             }
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      |   
                                                                                                                                                                                                                                                                                                                      |   
        $objVersandzonen = $this->Database->prepare("SELECT * FROM tl_shop_versandzonen;")->execute();                                                                                                                                                                                                                |         $objVersandzonen = $this->Database->prepare("SELECT * FROM tl_shop_versandzonen;")->execute();
                                                                                                                                                                                                                                                                                                                      |   
        while($objVersandzonen->next())                                                                                                                                                                                                                                                                               |         while($objVersandzonen->next())
        {                                                                                                                                                                                                                                                                                                             |         {
            $arrItem = $objVersandzonen->row();                                                                                                                                                                                                                                                                       |             $arrItem = $objVersandzonen->row();
            if(!$this->basketData['shippingMethod'])                                                                                                                                                                                                                                                                  |             if(!$this->basketData['shippingMethod']) 
            {                                                                                                                                                                                                                                                                                                         |             {
                $this->basketData['shippingMethod'] = $arrItem['id'];                                                                                                                                                                                                                                                 |                 $this->basketData['shippingMethod'] = $arrItem['id'];
            }                                                                                                                                                                                                                                                                                                         |             }
                                                                                                                                                                                                                                                                                                                      |   
            $arrVersandzonen[] = $arrItem;                                                                                                                                                                                                                                                                            |             $arrVersandzonen[] = $arrItem;
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      |         
        switch(strtolower($GLOBALS['TL_CONFIG']['versandberechnung']))                                                                                                                                                                                                                                                | 
        {                                                                                                                                                                                                                                                                                                             | 
            case "gewicht":                                                                                                                                                                                                                                                                                           | 
                $floatBerechnung = $this->floatBerechnung;                                                                                                                                                                                                                                                            | 
                break;;                                                                                                                                                                                                                                                                                               | 
            default:                                                                                                                                                                                                                                                                                                  | 
                $floatBerechnung = \AcquistoShop\acquistoShopCosts::costsCalculator($this->floatBerechnung, \AcquistoShop\acquistoShopCosts::getSelectedCurrency(), \AcquistoShop\acquistoShopCosts::getDefaultCurrency());                                                                                           |         $floatBerechnung = \AcquistoShop\acquistoShopCosts::costsCalculator($this->floatBerechnung, \AcquistoShop\acquistoShopCosts::getSelectedCurrency(), \AcquistoShop\acquistoShopCosts::getDefaultCurrency());
                break;;                                                                                                                                                                                                                                                                                               |         $objVersandarten = $this->Database->prepare("SELECT * FROM tl_shop_versandzonen_varten WHERE pid = ? && ab_einkaufpreis < ? ORDER BY ab_einkaufpreis ASC;")->execute($this->basketData['shippingMethod'], $floatBerechnung);
        }                                                                                                                                                                                                                                                                                                             | 
                                                                                                                                                                                                                                                                                                                      |         
        $objVersandarten = $this->Database->prepare("SELECT * FROM tl_shop_versandzonen_varten WHERE pid = ? && ab_einkaufpreis <= ? ORDER BY ab_einkaufpreis ASC;")->execute($this->basketData['shippingMethod'], $floatBerechnung);                                                                                 | 
                                                                                                                                                                                                                                                                                                                      |   
        while($objVersandarten->next())                                                                                                                                                                                                                                                                               |         while($objVersandarten->next()) 
        {                                                                                                                                                                                                                                                                                                             |         {
            if($objVersandarten->ab_einkaufpreis <= $floatBerechnung)                                                                                                                                                                                                                                                 |             if($objVersandarten->ab_einkaufpreis <= $floatBerechnung) 
            {                                                                                                                                                                                                                                                                                                         |             {
                $objZahlungsarten = $this->Database->prepare("SELECT * FROM tl_shop_zahlungsarten WHERE id = ?;")->execute($objVersandarten->zahlungsart_id);                                                                                                                                                         |                 $objZahlungsarten = $this->Database->prepare("SELECT * FROM tl_shop_zahlungsarten WHERE id = ?;")->execute($objVersandarten->zahlungsart_id);
                while($objZahlungsarten->next())                                                                                                                                                                                                                                                                      |                 while($objZahlungsarten->next())
                {                                                                                                                                                                                                                                                                                                     |                 {
                    $arrZahlungsart = $objZahlungsarten->row();                                                                                                                                                                                                                                                       |                     $arrZahlungsart = $objZahlungsarten->row();
                    $arrZahlungsart['preis']                 = \AcquistoShop\acquistoShopCosts::costsCalculator($objVersandarten->preis, \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());                                                              |                     $arrZahlungsart['preis']                 = \AcquistoShop\acquistoShopCosts::costsCalculator($objVersandarten->preis, \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());
                    $arrZahlungsart['ab_einkaufpreis']       = \AcquistoShop\acquistoShopCosts::costsCalculator($objVersandarten->ab_einkaufpreis, \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());                                                    |                     $arrZahlungsart['ab_einkaufpreis']       = \AcquistoShop\acquistoShopCosts::costsCalculator($objVersandarten->ab_einkaufpreis, \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());                     
                    $arrZahlungsart['sendID']                = $objVersandarten->id;                                                                                                                                                                                                                                  |                     $arrZahlungsart['sendID']                = $objVersandarten->id;
                    $arrZahlungsarten[$objZahlungsarten->id] = $arrZahlungsart;                                                                                                                                                                                                                                       |                     $arrZahlungsarten[$objZahlungsarten->id] = $arrZahlungsart;
                }                                                                                                                                                                                                                                                                                                     |                 }
            }                                                                                                                                                                                                                                                                                                         |             }
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      |   
        $this->Template = new \FrontendTemplate('mod_warenkorb_payment_and_shipping');                                                                                                                                                                                                                                |         $this->Template = new \FrontendTemplate('mod_warenkorb_payment_and_shipping');
        $this->Template->Zahlungsarten = $arrZahlungsarten;                                                                                                                                                                                                                                                           |         $this->Template->Zahlungsarten = $arrZahlungsarten;
        $this->Template->Versandzonen  = $arrVersandzonen;                                                                                                                                                                                                                                                            |         $this->Template->Versandzonen  = $arrVersandzonen;
        $this->Template->paymentError  = $paymentError;                                                                                                                                                                                                                                                               | 
        $this->Template->shippingError = $shippingError;                                                                                                                                                                                                                                                              | 
                                                                                                                                                                                                                                                                                                                      |   
        $this->Template->sel_pm = $this->basketData['paymentMethod'];                                                                                                                                                                                                                                                 |         $this->Template->sel_pm = $this->basketData['paymentMethod'];
        $this->Template->sel_sm = $this->basketData['shippingMethod'];                                                                                                                                                                                                                                                |         $this->Template->sel_sm = $this->basketData['shippingMethod'];    
    }                                                                                                                                                                                                                                                                                                                 |     }
                                                                                                                                                                                                                                                                                                                      |     
    private function basketCheckAndOrder()                                                                                                                                                                                                                                                                            |     private function basketCheckAndOrder() 
    {                                                                                                                                                                                                                                                                                                                 |     {
        $objPage = $this->Database->prepare("SELECT id, alias FROM tl_page WHERE id=?")->limit(1)->execute($this->replaceInsertTags($this->Shop->getInsertTagPID()));                                                                                                                                                 |         $objPage = $this->Database->prepare("SELECT id, alias FROM tl_page WHERE id=?")->limit(1)->execute($this->replaceInsertTags($this->Shop->getInsertTagPID()));
        $objWidget  = (object) $this->Basket->itemNum();                                                                                                                                                                                                                                                              |         $objWidget  = (object) $this->Basket->itemNum();
        $arrSteuern = $this->Basket->getTaxes();                                                                                                                                                                                                                                                                      |         $arrSteuern = $this->Basket->getTaxes();
                                                                                                                                                                                                                                                                                                                      |         
        $objVersandart    = $this->Database->prepare("SELECT * FROM tl_shop_versandzonen_varten WHERE id = ?;")->execute($this->basketData['paymentMethod']);                                                                                                                                                         |         $objVersandart    = $this->Database->prepare("SELECT * FROM tl_shop_versandzonen_varten WHERE id = ?;")->execute($this->basketData['paymentMethod']);
        $objVersandzone   = $this->Database->prepare("SELECT * FROM tl_shop_versandzonen WHERE id = ?;")->execute($objVersandart->pid);                                                                                                                                                                               |         $objVersandzone   = $this->Database->prepare("SELECT * FROM tl_shop_versandzonen WHERE id = ?;")->execute($objVersandart->pid);
        $objZahlungsarten = $this->Database->prepare("SELECT * FROM tl_shop_zahlungsarten WHERE id = ?;")->execute($objVersandart->zahlungsart_id);                                                                                                                                                                   |         $objZahlungsarten = $this->Database->prepare("SELECT * FROM tl_shop_zahlungsarten WHERE id = ?;")->execute($objVersandart->zahlungsart_id);
                                                                                                                                                                                                                                                                                                                      |     
        $this->Template                = new \FrontendTemplate('mod_warenkorb_check_and_order');                                                                                                                                                                                                                      |         $this->Template                = new \FrontendTemplate('mod_warenkorb_check_and_order');   
        $this->Template->Steuern       = $arrSteuern;                                                                                                                                                                                                                                                                 |         $this->Template->Steuern       = $arrSteuern;
        $this->Template->Produktliste  = $this->Basket->loadProducts($strUrl);                                                                                                                                                                                                                                        |         $this->Template->Produktliste  = $this->Basket->loadProducts($strUrl);  
        $this->Template->Zahlungsart   = (object) $objZahlungsarten->row();                                                                                                                                                                                                                                           |         $this->Template->Zahlungsart   = (object) $objZahlungsarten->row();
        $this->Template->Versandart    = (object) $objVersandart->row();                                                                                                                                                                                                                                              |         $this->Template->Versandart    = (object) $objVersandart->row();
        $this->Template->Versandzone   = (object) $objVersandzone->row();                                                                                                                                                                                                                                             |         $this->Template->Versandzone   = (object) $objVersandzone->row();
        $this->Template->Customer      = (object) $this->Session->get('Customer');                                                                                                                                                                                                                                    |         $this->Template->Customer      = (object) $this->Session->get('Customer');
        $this->Template->Deliver       = (object) $this->Session->get('Deliver');                                                                                                                                                                                                                                     |         $this->Template->Deliver       = (object) $this->Session->get('Deliver');
        $this->Template->Custom        = (object) $this->buildAddonFields(unserialize($this->acquistoShop_fieldsAddon), $this->Session->get('Custom'));                                                                                                                                                               |         $this->Template->Custom        = (object) $this->buildAddonFields(unserialize($this->acquistoShop_fieldsAddon), $this->Session->get('Custom'));    
        $this->Template->Versandpreis  = \AcquistoShop\acquistoShopCosts::costsCalculator($objVersandart->preis, \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());                                                                                      |         $this->Template->Versandpreis  = \AcquistoShop\acquistoShopCosts::costsCalculator($objVersandart->preis, \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());
                                                                                                                                                                                                                                                                                                                      |     
        if($objVersandzone->calculate_tax && $this->Basket->cardType == 'brutto')                                                                                                                                                                                                                                     |         if($objVersandzone->calculate_tax && $this->Basket->cardType == 'brutto') 
        {                                                                                                                                                                                                                                                                                                             |         {
            $this->Template->Gesamtpreis   = $this->Basket->getCosts();                                                                                                                                                                                                                                               |             $this->Template->Gesamtpreis   = $this->Basket->getCosts();
            $this->Template->Endpreis      = ($this->Basket->getCosts()) + \AcquistoShop\acquistoShopCosts::costsCalculator($objVersandart->preis, \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());                                                    |             $this->Template->Endpreis      = ($this->Basket->getCosts()) + \AcquistoShop\acquistoShopCosts::costsCalculator($objVersandart->preis, \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());
        }                                                                                                                                                                                                                                                                                                             |         } 
        elseif($this->Basket->cardType == 'netto')                                                                                                                                                                                                                                                                    |         elseif($this->Basket->cardType == 'netto') 
        {                                                                                                                                                                                                                                                                                                             |         {
            if($objVersandzone->calculate_tax)                                                                                                                                                                                                                                                                        |             if($objVersandzone->calculate_tax)
            {                                                                                                                                                                                                                                                                                                         |             {
                $this->Template->Gesamtpreis   = $this->Basket->getCosts() + $this->Basket->getTaxesSummary();                                                                                                                                                                                                        |                 $this->Template->Gesamtpreis   = $this->Basket->getCosts() + $this->Basket->getTaxesSummary();
                $this->Template->Endpreis      = ($this->Basket->getCosts() + $this->Basket->getTaxesSummary()) + \AcquistoShop\acquistoShopCosts::costsCalculator($objVersandart->preis, \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());             |                 $this->Template->Endpreis      = ($this->Basket->getCosts() + $this->Basket->getTaxesSummary()) + \AcquistoShop\acquistoShopCosts::costsCalculator($objVersandart->preis, \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());            
            }                                                                                                                                                                                                                                                                                                         |             }
            else                                                                                                                                                                                                                                                                                                      |             else
            {                                                                                                                                                                                                                                                                                                         |             {
                $this->Template->Gesamtpreis   = $this->Basket->getCosts();                                                                                                                                                                                                                                           |                 $this->Template->Gesamtpreis   = $this->Basket->getCosts();
                $this->Template->Endpreis      = ($this->Basket->getCosts()) + \AcquistoShop\acquistoShopCosts::costsCalculator($objVersandart->preis, \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());                                                |                 $this->Template->Endpreis      = ($this->Basket->getCosts()) + \AcquistoShop\acquistoShopCosts::costsCalculator($objVersandart->preis, \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());
            }                                                                                                                                                                                                                                                                                                         |             }
        }                                                                                                                                                                                                                                                                                                             |         }
        elseif($this->Basket->cardType == 'brutto')                                                                                                                                                                                                                                                                   |         elseif($this->Basket->cardType == 'brutto')
        {                                                                                                                                                                                                                                                                                                             |         {
            if($objVersandzone->calculate_tax)                                                                                                                                                                                                                                                                        |             if($objVersandzone->calculate_tax)
            {                                                                                                                                                                                                                                                                                                         |             {
                $this->Template->Gesamtpreis   = $this->Basket->getCosts() + $this->Basket->getTaxesSummary();                                                                                                                                                                                                        |                 $this->Template->Gesamtpreis   = $this->Basket->getCosts() + $this->Basket->getTaxesSummary();
                $this->Template->Endpreis      = ($this->Basket->getCosts() + $this->Basket->getTaxesSummary()) + \AcquistoShop\acquistoShopCosts::costsCalculator($objVersandart->preis, \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());             |                 $this->Template->Endpreis      = ($this->Basket->getCosts() + $this->Basket->getTaxesSummary()) + \AcquistoShop\acquistoShopCosts::costsCalculator($objVersandart->preis, \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());            
            }                                                                                                                                                                                                                                                                                                         |             }
            else                                                                                                                                                                                                                                                                                                      |             else
            {                                                                                                                                                                                                                                                                                                         |             {
                $this->Template->Gesamtpreis   = $this->Basket->getCosts() - $this->Basket->getTaxesSummary();                                                                                                                                                                                                        |                 $this->Template->Gesamtpreis   = $this->Basket->getCosts() - $this->Basket->getTaxesSummary();
                $this->Template->Endpreis      = ($this->Basket->getCosts() - $this->Basket->getTaxesSummary()) + \AcquistoShop\acquistoShopCosts::costsCalculator($objVersandart->preis, \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());             |                 $this->Template->Endpreis      = ($this->Basket->getCosts() - $this->Basket->getTaxesSummary()) + \AcquistoShop\acquistoShopCosts::costsCalculator($objVersandart->preis, \AcquistoShop\acquistoShopCosts::getDefaultCurrency(), \AcquistoShop\acquistoShopCosts::getSelectedCurrency());
            }                                                                                                                                                                                                                                                                                                         |             }        
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      |     
        $this->Template->paymentModule = sprintf($this->Payment->frontendTemplate($objZahlungsarten->payment_module, $objZahlungsarten->id), $this->generateFrontendUrl($objPage->fetchAssoc()) . "?do=pay", ($this->Basket->getCosts() + $objVersandart->preis));                                                    |         $this->Template->paymentModule = sprintf($this->Payment->frontendTemplate($objZahlungsarten->payment_module, $objZahlungsarten->id), $this->generateFrontendUrl($objPage->fetchAssoc()) . "?do=pay", ($this->Basket->getCosts() + $objVersandart->preis));  
    }                                                                                                                                                                                                                                                                                                                 |     }
                                                                                                                                                                                                                                                                                                                      |     
    private function basketPay()                                                                                                                                                                                                                                                                                      |     private function basketPay() 
    {                                                                                                                                                                                                                                                                                                                 |     {
        $objVersandart  = $this->Database->prepare("SELECT * FROM tl_shop_versandzonen_varten WHERE id = ?;")->execute($this->basketData['paymentMethod']);                                                                                                                                                           |         $objVersandart  = $this->Database->prepare("SELECT * FROM tl_shop_versandzonen_varten WHERE id = ?;")->execute($this->basketData['paymentMethod']);
        $objZahlungsart = $this->Database->prepare("SELECT * FROM tl_shop_zahlungsarten WHERE id = ?;")->execute($objVersandart->zahlungsart_id);                                                                                                                                                                     |         $objZahlungsart = $this->Database->prepare("SELECT * FROM tl_shop_zahlungsarten WHERE id = ?;")->execute($objVersandart->zahlungsart_id);
        $boolReturn     = $this->Payment->pay($objZahlungsart->payment_module, $objZahlungsart->id);                                                                                                                                                                                                                  |         $boolReturn     = $this->Payment->pay($objZahlungsart->payment_module, $objZahlungsart->id);
                                                                                                                                                                                                                                                                                                                      |         
        $payState = 'N';                                                                                                                                                                                                                                                                                              |         $payState = 'N';
        if($boolReturn) {                                                                                                                                                                                                                                                                                             |         if($boolReturn) {
            $payState = 'Y';                                                                                                                                                                                                                                                                                          |             $payState = 'Y';                
        }                                                                                                                                                                                                                                                                                                             |         }
                                                                                                                                                                                                                                                                                                                      |         
        if($boolReturn)                                                                                                                                                                                                                                                                                               |         if($boolReturn) 
        {                                                                                                                                                                                                                                                                                                             |         {
            $orderId = $this->Basket->writeOrder($this->Member->id, $this->basketData['paymentMethod'], $this->buildAddonFields(unserialize($this->acquistoShop_fieldsAddon), $this->Session->get('Custom')));                                                                                                        |             $orderId = $this->Basket->writeOrder($this->Member->id, $this->basketData['paymentMethod'], $this->buildAddonFields(unserialize($this->acquistoShop_fieldsAddon), $this->Session->get('Custom')));
            $orderObject = $this->Orders->getComplettOrder($orderId);                                                                                                                                                                                                                                                 |             $orderObject = $this->Orders->getComplettOrder($orderId);
                                                                                                                                                                                                                                                                                                                      |             
            $arrCardMail = array(                                                                                                                                                                                                                                                                                     |             $arrCardMail = array(
                'templateVars' => array(                                                                                                                                                                                                                                                                              |                 'templateVars' => array(
                    'Coupons'    => $orderObject->gutscheine,                                                                                                                                                                                                                                                         |                     'Coupons'    => $orderObject->gutscheine,
                    'Shopping'   => $orderObject->items,                                                                                                                                                                                                                                                              |                     'Shopping'   => $orderObject->items,
                    'Customer'   => $orderObject->customerData,                                                                                                                                                                                                                                                       |                     'Customer'   => $orderObject->customerData,
                    'Deliver'    => $orderObject->deliverAddress,                                                                                                                                                                                                                                                     |                     'Deliver'    => $orderObject->deliverAddress,
                    'Addon'      => $orderObject->customFields,                                                                                                                                                                                                                                                       |                     'Addon'      => $orderObject->customFields,
                    'Total'      => $this->Orders->getSummary($orderId),                                                                                                                                                                                                                                              |                     'Total'      => $this->Orders->getSummary($orderId),
                    'Taxes'      => $this->Orders->getTaxes($orderId),                                                                                                                                                                                                                                                |                     'Taxes'      => $this->Orders->getTaxes($orderId),
                    'Settings'   => $GLOBALS['TL_CONFIG'],                                                                                                                                                                                                                                                            |                     'Settings'   => $GLOBALS['TL_CONFIG'],
                    'Shipping'   => $orderObject->shipping,                                                                                                                                                                                                                                                           |                     'Shipping'   => $orderObject->shipping,
                    'Payment'    => $orderObject->payment,                                                                                                                                                                                                                                                            |                     'Payment'    => $orderObject->payment,
                    'Complete'   => $orderObject                                                                                                                                                                                                                                                                      | 
                ),                                                                                                                                                                                                                                                                                                    |                 ),
                'emailTemplate' => $this->acquistoShop_emailTemplate,                                                                                                                                                                                                                                                 |                 'emailTemplate' => $this->acquistoShop_emailTemplate,
                'emailFrom'          => array(                                                                                                                                                                                                                                                                        |                 'emailFrom'          => array(
                    'fromMail'  => $GLOBALS['TL_CONFIG']['bestell_email'],                                                                                                                                                                                                                                            |                     'fromMail'  => $GLOBALS['TL_CONFIG']['bestell_email'],
                    'fromName'  => $GLOBALS['TL_CONFIG']['firmenname'],                                                                                                                                                                                                                                               |                     'fromName'  => $GLOBALS['TL_CONFIG']['firmenname'],
                ),                                                                                                                                                                                                                                                                                                    |                 ),
                'sendTo'        => array(                                                                                                                                                                                                                                                                             |                 'sendTo'        => array(
                    'to'            => array(),                                                                                                                                                                                                                                                                       |                     'to'            => array(),
                    'cc'            => array(),                                                                                                                                                                                                                                                                       |                     'cc'            => array(),
                    'bcc'           => array($GLOBALS['TL_CONFIG']['bestell_email'])                                                                                                                                                                                                                                  |                     'bcc'           => array($GLOBALS['TL_CONFIG']['bestell_email'])
                ),                                                                                                                                                                                                                                                                                                    |                 ), 
                'emailSubject'  => 'Bestellung ' . $this->Shop->generateOrderID($orderId),                                                                                                                                                                                                                            |                 'emailSubject'  => 'Bestellung ' . $this->Shop->generateOrderID($orderID),
                'emailTyp'      => $this->acquistoShop_emailTyp,                                                                                                                                                                                                                                                      |                 'emailTyp'      => $this->acquistoShop_emailTyp,
                'agbFile'       => $this->acquistoShop_AGBFile,                                                                                                                                                                                                                                                       |                 'agbFile'       => $this->acquistoShop_AGBFile,
                'attachments'   => array()                                                                                                                                                                                                                                                                            |                 'attachments'   => array()                                                                                   
            );                                                                                                                                                                                                                                                                                                        |             );
                                                                                                                                                                                                                                                                                                                      |     
            $arrCardMail['sendTo']['to'] = array($orderObject->customerData->email);                                                                                                                                                                                                                                  |             $arrCardMail['sendTo']['to'] = array($orderObject->customerData->email);
            $this->Basket->sendOrderMail($this->acquistoShop_emailTemplate, $orderObject->customerData->email, $arrCardMail);                                                                                                                                                                                         |             $this->Basket->sendOrderMail($this->acquistoShop_emailTemplate, $orderObject->customerData->email, $arrCardMail);
                                                                                                                                                                                                                                                                                                                      | 
            $arrCardMail['sendTo']['to'] = array($GLOBALS['TL_CONFIG']['bestell_email']);                                                                                                                                                                                                                             |             $arrCardMail['sendTo']['to'] = array($GLOBALS['TL_CONFIG']['bestell_email']);
            $this->Basket->sendOrderMail($this->acquistoShop_emailTemplate_seller, $GLOBALS['TL_CONFIG']['bestell_email'], $arrCardMail);                                                                                                                                                                             |             $this->Basket->sendOrderMail($this->acquistoShop_emailTemplate_seller, $GLOBALS['TL_CONFIG']['bestell_email'], $arrCardMail);
                                                                                                                                                                                                                                                                                                                      | 
            $this->Template = new \FrontendTemplate('mod_warenkorb_pay');                                                                                                                                                                                                                                             |             $this->Template = new \FrontendTemplate('mod_warenkorb_pay');
        }                                                                                                                                                                                                                                                                                                             |         }    
    }                                                                                                                                                                                                                                                                                                                 |     }
                                                                                                                                                                                                                                                                                                                      |     
    private function basketTermsAndConditions()                                                                                                                                                                                                                                                                       |     private function basketTermsAndConditions() 
    {                                                                                                                                                                                                                                                                                                                 |     {
        if($this->Input->Post('agb') && $this->Input->Post('FORM_SUBMIT') == 'tl_acquisto_card_terms')                                                                                                                                                                                                                |         if($this->Input->Post('agb'))
        {                                                                                                                                                                                                                                                                                                             |         {
            $this->basketData['agb'] = 1;                                                                                                                                                                                                                                                                             |             $this->basketData['agb'] = 1;
            $this->Session->set('basket_data', $this->basketData);                                                                                                                                                                                                                                                    |             $this->Session->set('basket_data', $this->basketData);
            $this->redirect($this->getBasketUrl()  . "?do=check-and-order");                                                                                                                                                                                                                                          |             $this->redirect($this->getBasketUrl()  . "?do=check-and-order");
        }                                                                                                                                                                                                                                                                                                             |         }
        elseif( $this->Input->Post('FORM_SUBMIT') == 'tl_acquisto_card_terms')                                                                                                                                                                                                                                        | 
        {                                                                                                                                                                                                                                                                                                             | 
            $termsError = true;                                                                                                                                                                                                                                                                                       | 
        }                                                                                                                                                                                                                                                                                                             | 
                                                                                                                                                                                                                                                                                                                      |     
        $this->Template = new \FrontendTemplate('mod_warenkorb_agb');                                                                                                                                                                                                                                                 |         $this->Template = new \FrontendTemplate('mod_warenkorb_agb');
        $this->Template->AGB        = $GLOBALS['TL_CONFIG']['agb'];                                                                                                                                                                                                                                                   |         $this->Template->AGB = $GLOBALS['TL_CONFIG']['agb'];
        $this->Template->Widerruf   = $GLOBALS['TL_CONFIG']['widerruf'];                                                                                                                                                                                                                                              |         $this->Template->Widerruf = $GLOBALS['TL_CONFIG']['widerruf'];
        $this->Template->termsError = $termsError;                                                                                                                                                                                                                                                                    | 
        $this->Template->sel_agb    = $this->basketData['agb'];                                                                                                                                                                                                                                                       |         $this->Template->sel_agb = $this->basketData['agb'];    
    }                                                                                                                                                                                                                                                                                                                 |     }
}                                                                                                                                                                                                                                                                                                                     | }
                                                                                                                                                                                                                                                                                                                      | 
?>                                                                                                                                                                                                                                                                                                                    | ?>
                                                                                                                                                                                                                                                                                                                      | 